(()=>{"use strict";var e={d:(t,r)=>{for(var o in r)e.o(r,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:r[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{default:()=>a});const r={};function o(){throw new Error("Can't create instance of static class LocalStorage")}r.lacalStoragePrefix="storage:",r.parseData=function(e){try{return JSON.parse(e)}catch(t){return e}},r.stringifyData=function(e){return JSON.stringify({date:(new Date).toString(),time:Date.now(),data:e})},o.isSupported=function(){return"undefined"!=typeof Storage},o.get=function(e,t){if(this.isSupported()){let o=r.parseData(localStorage.getItem((t?"":r.lacalStoragePrefix)+e));return o&&(o.data||null)}return null},o.set=function(e,t){return this.isSupported()&&localStorage.setItem(r.lacalStoragePrefix+e,r.stringifyData(t)),this},o.remove=function(e){return this.isSupported()&&localStorage.removeItem(r.lacalStoragePrefix+e),this};class i{constructor(e){this.config=e,this.token=null,this.LOCALSTORAGE_TOKEN_KEY=`${e.namespace}:token`,this.LOCALSTORAGE_LOGIN_KEY=`${e.namespace}:login`}getRedirectUri(){return location.origin+"/"}login({social:e,redirect:t}){return e&&this.config.socials.includes(e)?this.loginBySocial({social:e,redirect:t}):Promise.reject(Error("Login with such params is not supported"))}async loginBySocial({social:e,open:t}){const r=this.getRedirectUri();t=t||location.pathname,o.set(this.LOCALSTORAGE_LOGIN_KEY,{social:e,redirect:r,open:t});const i=await this.getSocialUrl({social:e,redirect:r});location.href=i.replace(/^"/,"").replace(/"$/,"")}getSocialUrl({social:e,redirect:t}){return this.request({path:this.createPath(this.config.api.socialUrl,{social:e,redirect:t})})}async getTokenBySocial({social:e,redirect:t,search:r="?"}){const o=this.createPath(this.config.api.socialToken,{social:e,search:r,redirect:t}),i=await this.request({path:o});try{return JSON.parse(i)}catch(e){return null}}async loginSocialComplete(){const e=o.get(this.LOCALSTORAGE_LOGIN_KEY),t={redirect:!1};if(e&&e.social){o.remove(this.LOCALSTORAGE_LOGIN_KEY);const r=await this.getTokenBySocial({social:e.social,search:location.search,redirect:e.redirect});r&&(this.setToken(r),t.redirect=e.open)}return t}async getToken(){const e=this.token||o.get(this.LOCALSTORAGE_TOKEN_KEY);if(e&&e.expires_in){const t=Date.now();return 1e3*e.expires_in<t?await this.refreshToken(e):(this.token=e,e)}return null}async refreshToken(e){try{const t=await this.request({path:this.createPath(this.config.api.refreshToken),method:"POST",params:{refresh_token:e.refresh_token}},{headers:{"Content-Type":"application/json;charset=UTF-8",Authorization:`Bearer ${e.access_token}`}}),r=JSON.parse(t);if(r)return this.setToken(r),r}catch(e){return this.removeToken(),null}}setToken(e){o.set(this.LOCALSTORAGE_TOKEN_KEY,e),this.token=e}removeToken(){o.remove(this.LOCALSTORAGE_TOKEN_KEY),this.token=null}createPath(e,t={}){let r=e;return Object.keys(t).forEach((e=>{r=r.replace(`%{${e}}`,t[e])})),r}async logout(){try{const e=await this.getToken();await this.request({path:this.createPath(this.config.api.logout),method:"POST",params:{refreshToken:e.refreshToken}},{headers:{"Content-Type":"application/json;charset=UTF-8"}})}finally{this.removeToken()}}request({method:e="GET",path:t="/",params:r={}},o={}){return new Promise(((i,a)=>{const s=new XMLHttpRequest,n=this.config.endpoint+t;if(s.open(e,n,!0),o.headers)for(const e in o.headers)s.setRequestHeader(e,o.headers[e]);s.onload=()=>i(s.response),s.onerror=()=>a(s.response),"POST"===e?s.send(JSON.stringify(r)):s.send()}))}}const a=({app:e},t)=>{const r=JSON.parse('<%= JSON.stringify(options).replace(/^"/, "\'").replace(/"$/, "\'") %>'),o=new i(r);let a=!1;e.router.beforeEach((async(e,t,r)=>{if(!a){const e=await o.loginSocialComplete();if(await o.getToken(),a=!0,e.redirect)return r(e.redirect)}r()})),t("auth",o)};module.exports=t.default})();